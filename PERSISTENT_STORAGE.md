# Persistent Storage Configuration

## Overview

The Spectrum 4 Voting System requires persistent storage for:
- **Database** (`/app/data/`) - SQLite database files
- **Logs** (`/app/logs/`) - Application logs
- **Backups** (`/app/backups/`) - Database backups

**Important:** The Dockerfile declares these as volumes, but actual persistent storage is configured at **runtime** in your deployment platform.

## For Coolify Deployment

### Step 1: Update Coolify Storage Configuration

1. Go to your application in Coolify dashboard
2. Click on the **"Storages"** tab
3. Add/verify these persistent volumes:

| Mount Path (Container) | Host Path (Coolify Server) | Description |
|------------------------|----------------------------|-------------|
| `/app/data` | Auto-generated by Coolify | **Database storage** (REQUIRED) |
| `/app/logs` | Auto-generated by Coolify | Application logs |
| `/app/backups` | Auto-generated by Coolify | Database backups |

### Step 2: Add Storage in Coolify UI

For each volume:

1. Click **"+ Add Storage"**
2. Set **"Destination Path"**: (e.g., `/app/data`)
3. Leave **"Source Path"** empty (Coolify auto-generates)
4. Optional: Set a custom name (e.g., "Database Storage")
5. Click **"Save"**

Coolify will automatically create persistent volumes like:
- `/var/lib/coolify/applications/<app-id>/volumes/<volume-name>`

### Step 3: Redeploy Application

After adding storage:
1. Click **"Deploy"** button
2. Wait for deployment to complete
3. Your data will now persist across container restarts!

### Step 4: Verify Persistent Storage

SSH into your Coolify server and verify:

```bash
# Find your container
docker ps | grep stratavote

# Check mounted volumes
docker inspect <container-id> | grep -A 10 "Mounts"

# Verify database exists
docker exec <container-id> ls -la /app/data/

# Should see: data.sqlite
```

## For Docker Compose Deployment

If you're using docker-compose instead of Coolify, create a `docker-compose.yml`:

```yaml
version: '3.8'

services:
  stratavote:
    build: .
    container_name: stratavote
    ports:
      - "3300:3300"
    environment:
      - NODE_ENV=production
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - SESSION_SECRET=${SESSION_SECRET}
      - BASE_URL=${BASE_URL:-http://localhost:3300}
    volumes:
      # Persistent storage - CRITICAL for data retention
      - stratavote-data:/app/data
      - stratavote-logs:/app/logs
      - stratavote-backups:/app/backups
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3300/healthz"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

# Named volumes for persistent storage
volumes:
  stratavote-data:
    driver: local
  stratavote-logs:
    driver: local
  stratavote-backups:
    driver: local
```

Deploy with:
```bash
docker-compose up -d
```

## For Standard Docker Run

If running with `docker run`, use `-v` flags:

```bash
docker run -d \
  --name stratavote \
  -p 3300:3300 \
  -e NODE_ENV=production \
  -e ADMIN_PASSWORD="your-secure-password" \
  -e SESSION_SECRET="$(openssl rand -base64 32)" \
  -v stratavote-data:/app/data \
  -v stratavote-logs:/app/logs \
  -v stratavote-backups:/app/backups \
  --restart unless-stopped \
  stratavote:latest
```

## Verifying Data Persistence

### Test 1: Create Data and Restart

```bash
# 1. Create a council member in the UI
# 2. Restart the container
docker restart <container-name>

# 3. Verify data persists
# Login and check that council member still exists
```

### Test 2: Check Database File Location

```bash
# Inside container
docker exec <container-name> ls -la /app/data/

# Should show:
# data.sqlite
# data.sqlite-shm (WAL mode files)
# data.sqlite-wal
```

### Test 3: Verify Volume Mounting

```bash
# Check if volumes are mounted
docker inspect <container-name> | grep -A 10 "Mounts"

# Should show mounts for /app/data, /app/logs, /app/backups
```

## Backup and Restore

### Manual Backup

```bash
# Create a backup
docker exec <container-name> /app/scripts/backup.sh

# Download backup from container
docker cp <container-name>:/app/backups/data_2026-02-16_123456.sqlite ./backup.sqlite
```

### Restore from Backup

```bash
# Stop the container
docker stop <container-name>

# Copy backup into data volume
docker cp backup.sqlite <container-name>:/app/data/data.sqlite

# Start the container
docker start <container-name>
```

### Automated Backups

The backup script runs inside the container. To schedule backups:

**Option 1: Cron on Host Server**

```bash
# Create backup script on host
sudo nano /usr/local/bin/backup-stratavote.sh
```

```bash
#!/bin/bash
CONTAINER_NAME="stratavote"
BACKUP_HOST_DIR="/var/backups/stratavote"

# Create host backup directory
mkdir -p "$BACKUP_HOST_DIR"

# Run backup inside container
docker exec "$CONTAINER_NAME" /app/scripts/backup.sh

# Copy latest backup to host
LATEST_BACKUP=$(docker exec "$CONTAINER_NAME" ls -t /app/backups/ | head -1)
docker cp "$CONTAINER_NAME:/app/backups/$LATEST_BACKUP" "$BACKUP_HOST_DIR/"

echo "Backup completed: $LATEST_BACKUP"

# Clean up old host backups (keep 30 days)
find "$BACKUP_HOST_DIR" -name "data_*.sqlite" -mtime +30 -delete
```

```bash
# Make executable
sudo chmod +x /usr/local/bin/backup-stratavote.sh

# Add to crontab (daily at 2 AM)
sudo crontab -e
0 2 * * * /usr/local/bin/backup-stratavote.sh >> /var/log/stratavote-backup.log 2>&1
```

**Option 2: Coolify Scheduled Tasks**

Coolify doesn't natively support scheduled tasks, so use the cron method above.

## Migrating Existing Data

If you already have a database and need to migrate:

### 1. Export from Old Container

```bash
# Old location: /app/data.sqlite
docker cp old-container:/app/data.sqlite ./old-data.sqlite
```

### 2. Import to New Container

```bash
# New location: /app/data/data.sqlite
docker cp ./old-data.sqlite new-container:/app/data/data.sqlite

# Fix permissions
docker exec new-container chown nodejs:nodejs /app/data/data.sqlite
docker exec new-container chmod 644 /app/data/data.sqlite

# Restart
docker restart new-container
```

## Monitoring Storage

### Check Disk Usage

```bash
# Inside container
docker exec <container-name> du -sh /app/data /app/logs /app/backups

# On host (Coolify)
sudo du -sh /var/lib/coolify/applications/*/volumes/*
```

### Log Rotation

Application logs can grow large. Consider log rotation:

```bash
# Rotate logs manually
docker exec <container-name> sh -c "
  cd /app/logs
  mv combined.log combined.log.old
  mv error.log error.log.old
  gzip combined.log.old error.log.old
"

# Or install logrotate in Dockerfile (future enhancement)
```

## Troubleshooting

### Problem: Database File Not Found

```bash
# Check if data directory exists
docker exec <container-name> ls -la /app/data/

# Check permissions
docker exec <container-name> ls -la /app/

# Recreate database (will lose data!)
docker exec <container-name> rm -f /app/data/data.sqlite
docker restart <container-name>
```

### Problem: Permission Denied

```bash
# Fix permissions
docker exec <container-name> chown -R nodejs:nodejs /app/data /app/logs /app/backups
docker exec <container-name> chmod -R 755 /app/data /app/logs /app/backups
```

### Problem: Data Lost After Restart

This means volumes are NOT mounted correctly.

**Check:**
```bash
# Verify volumes in Coolify UI
# Or inspect Docker mounts
docker inspect <container-name> | grep -A 10 "Mounts"
```

**If no mounts shown:**
- Volumes were not configured
- Data was stored in container filesystem (non-persistent)
- Need to reconfigure volumes in Coolify

**Recovery:**
- Check if backup exists in /app/backups before restart
- Configure volumes properly
- Redeploy

### Problem: Volume Permission Errors in Coolify

If Coolify creates volumes with wrong permissions:

```bash
# SSH to Coolify server
sudo chown -R 1001:1001 /var/lib/coolify/applications/<app-id>/volumes/*

# Restart container
docker restart <container-name>
```

## Storage Size Recommendations

| Component | Initial Size | Growth Rate | Recommended |
|-----------|-------------|-------------|-------------|
| Database | <1 MB | ~100 KB per motion | 1 GB |
| Logs | 0 | ~10 MB per month | 5 GB |
| Backups | 0 | ~1 MB per backup | 10 GB |
| **Total** | - | - | **20 GB** |

## Security Considerations

1. **Backup Encryption:**
   - Consider encrypting backups before storing
   - Use `gpg` or similar tools

2. **Access Control:**
   - Restrict access to volume directories on host
   - Only root and docker users should access

3. **Regular Backups:**
   - Store backups off-site (S3, remote server)
   - Test restore procedures regularly

4. **Monitoring:**
   - Set up disk space alerts
   - Monitor for unusual database growth

## Summary

✅ **Dockerfile** - Declares volumes (`VOLUME` instruction)
✅ **Coolify/Runtime** - Mounts actual persistent storage
✅ **Database Path** - `/app/data/data.sqlite`
✅ **Logs Path** - `/app/logs/`
✅ **Backups Path** - `/app/backups/`

**Critical:** Configure storage in Coolify UI before deploying to production!

---

**Need Help?**
- Coolify Documentation: https://coolify.io/docs
- GitHub Issues: https://github.com/dcook604/stratavote/issues
